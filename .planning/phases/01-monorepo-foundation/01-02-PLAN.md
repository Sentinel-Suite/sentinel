---
phase: 01-monorepo-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - packages/config/package.json
  - packages/config/src/index.ts
  - packages/config/src/env.ts
  - packages/db/package.json
  - packages/db/src/index.ts
  - packages/db/src/client.ts
  - packages/db/src/schema/control.ts
  - packages/db/drizzle.control.config.ts
  - docker/docker-compose.yml
  - docker/init-scripts/01-create-databases.sql
  - docker/grafana/provisioning/datasources/datasources.yml
  - docker/grafana/provisioning/dashboards/dashboards.yml
  - docker/grafana/dashboards/sentinel-overview.json
  - docker/prometheus/prometheus.yml
  - docker/loki/loki-config.yml
  - docker/traefik/traefik.yml
  - Makefile
  - .env.example
autonomous: true
requirements:
  - INFR-03
  - INFR-04

must_haves:
  truths:
    - "Missing or invalid environment variables produce clear error messages at startup, not silent failures"
    - "Docker Compose brings up PostgreSQL and Redis with docker compose --profile core up"
    - "The API can connect to both PostgreSQL and Redis when Docker infrastructure is running"
    - "Docker Compose full profile starts all 12+ services without port conflicts"
    - "Drizzle can execute queries against the control database"
  artifacts:
    - path: "packages/config/src/env.ts"
      provides: "Zod-validated environment configuration"
      exports: ["env"]
      contains: "createEnv"
    - path: "packages/db/src/client.ts"
      provides: "Drizzle database instances (control + tenant factory)"
      exports: ["controlDb", "createTenantDb"]
      contains: "drizzle"
    - path: "packages/db/src/schema/control.ts"
      provides: "Control database schema"
      contains: "pgTable"
    - path: "packages/db/drizzle.control.config.ts"
      provides: "Drizzle Kit config for control database migrations"
      contains: "defineConfig"
    - path: "docker/docker-compose.yml"
      provides: "Docker Compose infrastructure with core and full profiles"
      contains: "sentinel-net"
    - path: "Makefile"
      provides: "Docker convenience commands"
      contains: "docker compose"
  key_links:
    - from: "packages/config/src/env.ts"
      to: "process.env"
      via: "t3-env createEnv with Zod schemas"
      pattern: "createEnv"
    - from: "packages/db/src/client.ts"
      to: "packages/config/src/env.ts"
      via: "imports env for CONTROL_DATABASE_URL"
      pattern: "import.*env.*from.*@sentinel/config"
    - from: "docker/docker-compose.yml"
      to: ".env"
      via: "Docker env var substitution for all ports"
      pattern: "\\$\\{.*_PORT:-"
    - from: "docker/init-scripts/01-create-databases.sql"
      to: "docker/docker-compose.yml"
      via: "Postgres init script volume mount"
      pattern: "docker-entrypoint-initdb"
---

<objective>
Implement environment configuration with Zod validation (packages/config), database connection setup with Drizzle ORM (packages/db), and the complete Docker Compose infrastructure with core and full profiles.

Purpose: Provide runtime configuration validation (clear errors for missing env vars), database connectivity (control DB + tenant DB factory pattern), and local infrastructure (PostgreSQL, Redis, observability stack, tooling services).
Output: Functional @sentinel/config and @sentinel/db packages, Docker Compose with 12+ services across core/full profiles, Makefile for Docker operations.
</objective>

<execution_context>
@/Users/darreljones/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darreljones/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-monorepo-foundation/01-CONTEXT.md
@.planning/phases/01-monorepo-foundation/01-RESEARCH.md
@.planning/phases/01-monorepo-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement @sentinel/config (Zod env validation) and @sentinel/db (Drizzle connection + control schema)</name>
  <files>
    packages/config/package.json, packages/config/src/index.ts, packages/config/src/env.ts,
    packages/db/package.json, packages/db/src/index.ts, packages/db/src/client.ts, packages/db/src/schema/control.ts, packages/db/drizzle.control.config.ts
  </files>
  <action>
    **packages/config (Zod env validation via @t3-oss/env-core):**

    1. Add dependencies to packages/config/package.json: `@t3-oss/env-core`, `zod`. These are runtime dependencies (not dev).
    2. Create `packages/config/src/env.ts` using the research Pattern 4 as the base:
       ```
       import { createEnv } from '@t3-oss/env-core';
       import { z } from 'zod';
       ```
       Define server variables with Zod schemas:
       - NODE_ENV: z.enum(['development', 'production', 'test']).default('development')
       - LOG_LEVEL: z.enum(['trace', 'debug', 'info', 'warn', 'error', 'fatal']).default('debug')
       - CONTROL_DATABASE_URL: z.string().url() -- REQUIRED, no default
       - REDIS_URL: z.string().url() -- REQUIRED, no default
       - API_PORT: z.coerce.number().default(3500)
       - WEB_PORT: z.coerce.number().default(3501)
       - ADMIN_PORT: z.coerce.number().default(3502)
       - OTEL_EXPORTER_OTLP_ENDPOINT: z.string().url().optional()
       - LOKI_URL: z.string().url().optional()
       - METRICS_PORT: z.coerce.number().default(9464)
       - SENTRY_DSN: z.string().url().optional()
       - FLAGSMITH_SERVER_SIDE_KEY: z.string().optional()

       Set `runtimeEnv: process.env` and `emptyStringAsUndefined: true`.
    3. Update `packages/config/src/index.ts` to re-export: `export { env } from './env';` and also export the zod schemas for reuse.

    **packages/db (Drizzle ORM connection + control schema):**

    1. Add dependencies to packages/db/package.json:
       - Runtime: `drizzle-orm@0.45`, `pg`
       - Dev: `drizzle-kit`, `@types/pg`
       - Workspace: `"@sentinel/config": "workspace:*"`
    2. Create `packages/db/src/schema/control.ts`:
       - Define a minimal `system_info` table using Drizzle's `pgTable`:
         ```
         import { pgTable, text, timestamp, uuid } from 'drizzle-orm/pg-core';
         export const systemInfo = pgTable('system_info', {
           id: uuid('id').defaultRandom().primaryKey(),
           key: text('key').notNull().unique(),
           value: text('value').notNull(),
           createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
           updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
         });
         ```
       - This table exists for health check verification (SELECT 1 is fine, but a real table proves schema migration works).
    3. Create `packages/db/src/client.ts` per research Pattern 3:
       - Import `env` from `@sentinel/config`
       - Create `controlPool` as a `Pool` from `pg` using `env.CONTROL_DATABASE_URL`
       - Export `controlDb = drizzle({ client: controlPool, schema: controlSchema })`
       - Export `createTenantDb(connectionUrl: string)` factory function for Phase 2+
       - Export a `closeConnections()` function for graceful shutdown
    4. Update `packages/db/src/index.ts` to re-export: controlDb, createTenantDb, closeConnections, and all schema exports.
    5. Create `packages/db/drizzle.control.config.ts`:
       ```
       import { defineConfig } from 'drizzle-kit';
       export default defineConfig({
         schema: './src/schema/control.ts',
         out: './drizzle/control',
         dialect: 'postgresql',
         dbCredentials: {
           url: process.env.CONTROL_DATABASE_URL!,
         },
       });
       ```
       Per research Pitfall 8 -- separate config per database.
    6. Add scripts to packages/db/package.json:
       - "db:push": "drizzle-kit push --config=drizzle.control.config.ts"
       - "db:generate": "drizzle-kit generate --config=drizzle.control.config.ts"
       - "db:studio": "drizzle-kit studio --config=drizzle.control.config.ts"
       - "migrate": "drizzle-kit push --config=drizzle.control.config.ts"

    Run `pnpm install` after adding dependencies. Verify TypeScript compilation: `pnpm --filter @sentinel/config exec tsc --noEmit && pnpm --filter @sentinel/db exec tsc --noEmit`.
  </action>
  <verify>
    <automated>cd /Users/darreljones/Development/sentinel-suite && pnpm install && pnpm --filter @sentinel/config exec tsc --noEmit && pnpm --filter @sentinel/db exec tsc --noEmit && echo "TypeScript compilation passed"</automated>
  </verify>
  <done>
    @sentinel/config exports `env` with Zod-validated environment variables. Missing CONTROL_DATABASE_URL or REDIS_URL produces a clear validation error. @sentinel/db exports controlDb (Drizzle instance), createTenantDb factory, and control schema. Drizzle Kit config exists for control database migrations. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Docker Compose infrastructure with core/full profiles and Makefile</name>
  <files>
    docker/docker-compose.yml, docker/init-scripts/01-create-databases.sql,
    docker/grafana/provisioning/datasources/datasources.yml, docker/grafana/provisioning/dashboards/dashboards.yml, docker/grafana/dashboards/sentinel-overview.json,
    docker/prometheus/prometheus.yml, docker/loki/loki-config.yml, docker/traefik/traefik.yml,
    Makefile, .env.example
  </files>
  <action>
    **Docker Compose (docker/docker-compose.yml):**

    Use research Pattern 6 as the base. Create the complete Docker Compose file with two profiles:

    **Core profile (fast startup -- Postgres + Redis only):**
    - `postgres` (postgres:16-alpine): profiles [core, full], port ${POSTGRES_PORT:-3510}:5432, persistent volume `postgres_data`, network sentinel-net, environment from .env. Volume mount `./init-scripts:/docker-entrypoint-initdb.d` for multi-database creation. Health check: `pg_isready -U ${POSTGRES_USER:-sentinel}`.
    - `redis` (redis:7-alpine): profiles [core, full], port ${REDIS_PORT:-3511}:6379, persistent volume `redis_data`, network sentinel-net, command `redis-server --appendonly yes`. Health check: `redis-cli ping`.

    **Full profile (adds all tooling):**
    - `traefik` (traefik:v3.3): profiles [full], ports 80:80 and ${TRAEFIK_DASHBOARD_PORT:-3580}:8080, Docker provider enabled, exposed-by-default false, web entrypoint. Mount docker.sock read-only.
    - `grafana` (grafana/grafana:latest): profiles [full], port ${GRAFANA_PORT:-3530}:3000, persistent volume `grafana_data`. Auto-provision datasources (Loki, Prometheus, Jaeger) via volume mount. Environment: GF_AUTH_ANONYMOUS_ENABLED=true, GF_AUTH_ANONYMOUS_ORG_ROLE=Admin (dev convenience).
    - `loki` (grafana/loki:latest): profiles [full], port ${LOKI_PORT:-3531}:3100, config file mount.
    - `prometheus` (prom/prometheus:latest): profiles [full], port ${PROMETHEUS_PORT:-3532}:9090, config file mount. Scrape targets: sentinel-api:9464.
    - `jaeger` (jaegertracing/jaeger:latest): profiles [full], ports ${JAEGER_UI_PORT:-3533}:16686 and ${JAEGER_OTLP_PORT:-4318}:4318. Environment: COLLECTOR_OTLP_ENABLED=true.
    - `glitchtip` (glitchtip/glitchtip:latest): profiles [full], depends_on postgres and redis, port ${GLITCHTIP_PORT:-3540}:8000. Environment: DATABASE_URL pointing to glitchtip database in postgres, SECRET_KEY, REDIS_URL (use /1 database). Per research Pitfall 6 -- separate DB.
    - `flagsmith` (flagsmith/flagsmith:latest): profiles [full], depends_on postgres, port ${FLAGSMITH_PORT:-3541}:8000. Environment: DATABASE_URL pointing to flagsmith database in postgres. Per research Pitfall 6 -- separate DB.
    - `mailpit` (axllent/mailpit:latest): profiles [full], ports ${MAILPIT_SMTP_PORT:-3525}:1025 and ${MAILPIT_UI_PORT:-3526}:8025.
    - `pgadmin` (dpage/pgadmin4:latest): profiles [full], port ${PGADMIN_PORT:-3550}:80. Environment: PGADMIN_DEFAULT_EMAIL, PGADMIN_DEFAULT_PASSWORD.

    All services on `sentinel-net` bridge network. Named volumes: postgres_data, redis_data, grafana_data.

    CRITICAL: Every port must use `${ENV_VAR:-default}` syntax. No hardcoded ports. All defaults per research port table.

    **Postgres Init Script (docker/init-scripts/01-create-databases.sql):**
    ```sql
    -- Create separate databases for services that need their own
    CREATE DATABASE glitchtip;
    CREATE DATABASE flagsmith;
    -- sentinel_control is created by POSTGRES_DB env var
    ```
    Per research recommendation for Pitfall 6.

    **Grafana Provisioning:**
    - `docker/grafana/provisioning/datasources/datasources.yml`: Auto-provision Loki (http://loki:3100), Prometheus (http://prometheus:9090), and Jaeger (http://jaeger:16686) as datasources.
    - `docker/grafana/provisioning/dashboards/dashboards.yml`: Dashboard provider pointing to /var/lib/grafana/dashboards.
    - `docker/grafana/dashboards/sentinel-overview.json`: A basic dashboard with panels for: API request rate (Prometheus), log volume (Loki), trace count (Jaeger). Keep it simple -- 3-4 panels.

    **Prometheus Config (docker/prometheus/prometheus.yml):**
    Scrape config targeting sentinel-api at host.docker.internal:9464 (metrics endpoint). Scrape interval: 15s.

    **Loki Config (docker/loki/loki-config.yml):**
    Minimal Loki config: auth disabled, server http_listen_port 3100, filesystem storage, schema v13, index boltdb-shipper.

    **Traefik Config (docker/traefik/traefik.yml):**
    Static config: Docker provider (endpoint unix:///var/run/docker.sock, exposedByDefault false), web entrypoint (address :80), api (insecure true for dashboard).

    **Makefile:**
    Per research code example, plus additional targets:
    - `up`: `docker compose -f docker/docker-compose.yml --profile core up -d`
    - `up-full`: `docker compose -f docker/docker-compose.yml --profile full up -d`
    - `down`: `docker compose -f docker/docker-compose.yml down`
    - `clean`: `docker compose -f docker/docker-compose.yml down -v --remove-orphans` (clean slate)
    - `reset-db`: down -v, up core, sleep 3, pnpm --filter @sentinel/db run migrate
    - `logs`: `docker compose -f docker/docker-compose.yml logs -f`
    - `ps`: `docker compose -f docker/docker-compose.yml ps`
    - Each target has a ## comment for `make help` self-documentation.
    - Add a `help` target that greps for ## comments.

    **Update .env.example:**
    Ensure all Docker-related env vars from the port table are documented with their defaults and descriptions. Group by section: App Ports, Database, Redis, Observability, Error Tracking, Feature Flags, Email, Admin Tools.

    After creating all files, run `make up` to verify core profile starts, then `make down`.
  </action>
  <verify>
    <automated>cd /Users/darreljones/Development/sentinel-suite && docker compose -f docker/docker-compose.yml config --profiles core && test -f Makefile && test -f docker/init-scripts/01-create-databases.sql && test -f docker/grafana/provisioning/datasources/datasources.yml && test -f docker/prometheus/prometheus.yml && test -f docker/loki/loki-config.yml && echo "Docker config valid"</automated>
  </verify>
  <done>
    Docker Compose validates without errors for both core and full profiles. All 12+ services defined with configurable ports. Postgres init script creates glitchtip and flagsmith databases. Grafana auto-provisions Loki, Prometheus, and Jaeger datasources. Makefile provides up, up-full, down, clean, reset-db, logs, ps, and help targets. .env.example documents all environment variables.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @sentinel/config exec tsc --noEmit` passes (config package compiles)
2. `pnpm --filter @sentinel/db exec tsc --noEmit` passes (db package compiles)
3. `docker compose -f docker/docker-compose.yml config --profiles core` validates without errors
4. `docker compose -f docker/docker-compose.yml config --profiles full` validates without errors
5. Setting CONTROL_DATABASE_URL="" and importing @sentinel/config throws a clear Zod validation error
6. Makefile targets (up, down, clean, reset-db) exist and use correct docker compose commands
</verification>

<success_criteria>
- @sentinel/config validates all environment variables with Zod at import time
- Missing required env vars produce clear error messages listing what's missing
- @sentinel/db exports controlDb (Drizzle instance) and createTenantDb factory
- Drizzle Kit config exists for control database with separate output directory
- Docker Compose core profile starts Postgres and Redis in under 30 seconds
- Docker Compose full profile defines all 12+ services with no port conflicts
- Makefile provides all convenience targets documented in CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-monorepo-foundation/01-02-SUMMARY.md`
</output>
